<div class="overlay" [class.active]="layout.cartOpen()" (click)="layout.closeCart()"></div>

<aside class="cart-drawer" [class.active]="layout.cartOpen()">
  <div class="drawer-header">
    <h3>Tu Carrito ({{ cartService.cartItems().length }})</h3>
    <button class="btn-close" (click)="layout.closeCart()">‚úï</button>
  </div>

  <div class="drawer-body">
    @if (cartService.cartItems().length === 0) {
    <div class="empty-state">
      <span class="empty-icon">üõçÔ∏è</span>
      <p>Tu carrito est√° vac√≠o</p>
      <button class="btn-shop" (click)="layout.closeCart()">Empezar a comprar</button>
    </div>
    } @else {
    <ul class="cart-list">
      @for (item of cartService.cartItems(); track item.product._id) {
      <li class="cart-item">
        <div class="item-img">
          <img [src]="URL_IMG + item.product.images[0].src || 'assets/placeholder.png'" alt="Product" />
        </div>

        <div class="item-details">
          <div class="row-top">
            <a class="item-title">{{ item.product.title }}</a>
            <button class="btn-remove" (click)="cartService.removeCartItem(item)" title="Eliminar">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="3 6 5 6 21 6"></polyline>
                <path
                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                ></path>
              </svg>
            </button>
          </div>
          <div class="">
            <a class="item-variety">Variente: {{ item.variety | uppercase }}</a>
          </div>
          <div class="row-bottom">
            <div class="qty-selector">
              <button class="qty-btn minus" (click)="cartService.updateCartQuantity(item, -1)">‚àí</button>
              <span class="qty-value">{{ item.quantity }}</span>
              <button class="qty-btn plus" (click)="cartService.updateCartQuantity(item, 1)">+</button>
            </div>

            <div class="price-group">
              @if(item.discount > 0) {
              <span class="old-price">{{item.quantity}} x {{ item.unit_price | currency : cartService.Currency.currency }}</span>
              }
              <span class="final-price">{{ item.total | currency : cartService.Currency.currency }}</span>
            </div>
          </div>
        </div>
      </li>
      }
    </ul>
    }
  </div>

  @if (cartService.cartItems().length > 0) {
  <div class="drawer-footer">
    <div class="summary-row">
      <span>Subtotal:</span>
      <span class="total-amount">{{ cartService.cartTotal() | currency : cartService.Currency.currency }}</span>
    </div>
    <p class="shipping-note">El env√≠o se calcula en el checkout.</p>

    <button class="btn-checkout" routerLink="/checkout" (click)="layout.closeCart()" >FINALIZAR COMPRA</button>
    @if (!authService.isAuthenticated()) {
    <div class="sync-msg">
      <small>¬øYa tienes cuenta? <a href="/login">Inicia sesi√≥n</a> para guardar tu carrito.</small>
    </div>
    } @else { }
  </div>
  }
</aside>
